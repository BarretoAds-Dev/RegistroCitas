---
import BookingWelcome from '@/2-app-crm/1-BookingForm/components/BookingWelcome.astro';
import Layout from '@/layouts/Layout.astro';

//  Configuraci贸n por defecto (puede venir de Supabase en el futuro)
const config = {
	slotDuration: 45,
	bufferTime: 5,
	businessHours: {}
};

//  Cargar disponibilidad desde API de Supabase
// Solo intentar fetch en runtime, no durante build
let filteredSlots: any[] = [];

// Solo hacer fetch si estamos en modo desarrollo o producci贸n con servidor disponible
if (import.meta.env.DEV || import.meta.env.PUBLIC_SUPABASE_URL) {
	try {
		const startDate = new Date().toISOString().split('T')[0];
		const endDate = new Date();
		endDate.setMonth(endDate.getMonth() + 6);
		const endDateStr = endDate.toISOString().split('T')[0];

		// En desarrollo, usar localhost; en producci贸n, usar la URL del sitio
		const baseUrl = import.meta.env.DEV
			? 'http://localhost:4321'
			: (import.meta.env.SITE || import.meta.env.PUBLIC_SITE_URL || '');

		if (baseUrl) {
			const response = await fetch(`${baseUrl}/api/appointments/available?start=${startDate}&end=${endDateStr}`, {
				// Solo en desarrollo, permitir fetch durante SSR
				// En producci贸n, esto se har谩 en el cliente
				headers: import.meta.env.DEV ? {} : { 'Cache-Control': 'no-cache' }
			});

			if (response.ok) {
				filteredSlots = await response.json();
			}
		}
	} catch (error) {
		// Silenciar errores durante build - los slots se cargar谩n en el cliente
		if (import.meta.env.DEV) {
			console.warn('Error al cargar disponibilidad desde API:', error);
		}
	}
}
---

<Layout>
	<BookingWelcome
		availableSlots={filteredSlots}
		config={config}
		client:visible
	/>
</Layout>

